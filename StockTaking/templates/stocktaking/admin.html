<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    {% csrf_token %}
</head>

<style>
    body, html {
        height: 100%;
        margin: 0;
    }

    .table_container {
        display: flex;
        flex-direction: column;

        align-items: center;
    }

    .table_view {
        margin-top: 20px;
    }

    table, th, td {
        border-collapse: collapse;
        margin: 0 auto;
    }

    th, td {
        padding: 10px;
        text-align: center; 
    }

    th {
        background-color: red;
    }

    tr:nth-child(even) {
        background-color: #bbbbbb;
    }

    td {
        position: relative;
        outline: 0;
    }

</style>

<body>
    {% include '_nav.html' %}

    <div class="table_nav">
        <button class="user_btn">Users</button>
        <button class="transaction_type_btn">Transaction Types</button>
    </div>

    <div class="table_container">
        <div class="table_view">

        </div>
        <div class="table_add">

        </div>
    </div>

</body>

{% load static %}

<script src="{% static 'jquery.js' %}"></script>
<script>
    let user_btn = document.querySelector('.user_btn');
    let transaction_type_btn = document.querySelector('.transaction_type_btn');

    let current_table = null;

    window.addEventListener('click', (e) => {
        if (current_table) {
            let editing = current_table.findEditing();
            if (editing) {
                if (!editing.contains(e.target)) {
                    current_table.cancelEditing(editing);
                }
            }
        }
    });

    class Table {
        constructor(table_name, headers, types, data) {
            this.table_name = table_name;
            this.headers = headers;
            this.types = types;
            this.data = data;

            this.table = null;

            this.init();
        }

        init() {
            this.draw_table_view();
        }

        draw_table_view() {
            let table_view = document.querySelector('.table_view');
            table_view.innerHTML = '';

            this.table = document.createElement('table');
            this.table.classList.add('table');
            this.table.classList.add(this.table_name);

            let table_body = document.createElement('tdody');

            let table_head_row = document.createElement('tr');
            for (let i = 0; i < this.headers.length; i++) {
                let table_head_cell = document.createElement('th');
                table_head_cell.innerHTML = `${this.headers[i]} : ${this.types[i]}`;
                table_head_row.appendChild(table_head_cell);
            }
            table_body.appendChild(table_head_row);

            for (let row=0; row<this.data.length; row++) {
                let table_body_row = document.createElement('tr');
                let row_id = this.data[row][0];

                for (let col=0; col<this.headers.length; col++) {
                    let table_body_cell = document.createElement('td');
                    
                    let cell_name = this.headers[col];
                    let cell_type = this.types[col];
                    let cell_value = this.data[row][col];

                    table_body_cell.innerHTML = cell_value;
                    table_body_cell.setAttribute('data-id', row_id);
                    table_body_cell.setAttribute('data-type', cell_type);
                    table_body_cell.setAttribute('data-key', cell_name);
                    table_body_cell.setAttribute('data-value', cell_value);

                    if (cell_name != 'id') {
                        table_body_cell.addEventListener('dblclick', (e) => {
                            if (!this.inEditing(e.target)) {
                                this.startEditing(e.target);
                            }
                        })  
                    }
                    

                    table_body_row.appendChild(table_body_cell);
                }
                table_body.appendChild(table_body_row);
            }

            this.table.appendChild(table_body);
            table_view.appendChild(this.table);
        }

        draw_table_add() {

        }

        get_headers() {
            return this.headers;
        }

        get_types() {
            return this.types;
        }

        get_data() {
            return this.data;
        }

        startEditing(td) {
            let current_editing = this.findEditing();
            if (current_editing) {
                this.cancelEditing(current_editing);
            }

            td.classList.add('editing');
            this.createEditingToolbar(td);

            let input = td.querySelector('.toolbar-input');
            input.focus();
        }

        cancelEditing(td) {
            td.innerHTML = td.getAttribute('data-value');
            td.classList.remove('editing');
            //this.removeToolbar();
        }

        clickOff() {

        }

        finishEditing(td) {
            td.classList.remove('editing');

            let input = td.querySelector('input');
            let new_value = null;
            if (input.getAttribute('type') == 'checkbox') {
                if (input.checked) {
                    new_value = 1;
                }
                else {
                    new_value = 0;  
                }
            } else {
                new_value = input.value;
            }

            this.sendData(td, new_value);
        
            td.innerHTML = '';
            td.innerHTML = new_value;
        }

        inEditing(td) {
            return td.classList.contains('editing');
        }

        createEditingToolbar(td) {
            const save_btn = document.createElement('button');
            const cancel_btn = document.createElement('button');
            const data_type = td.getAttribute('data-type');
            let input_type = null;
            switch (data_type){
                case 'int':
                    input_type = 'number';
                    break;
                case 'str':
                    input_type = 'text';
                    break;
                case 'bool':
                    input_type = 'checkbox';
                    break;
                case 'date':
                    input_type = 'date';
                    break;
                case 'datetime':
                    input_type = 'datetime-local';
                    break;
                case 'float':
                    input_type = 'number';
                    break;
                default:
                    input_type = 'text';
                    break;

            }
            const input = document.createElement('input');
            input.setAttribute('type', input_type);
            if (input_type == 'checkbox') {
                if (td.getAttribute('data-value') != '0') {
                    input.checked = true;
                }
                else {
                    input.checked = false;
                }
            }
            else {
                input.setAttribute('value', td.getAttribute('data-value'));
            }
            input.classList.add('toolbar-input');
            const toolbar = document.createElement('div');

            save_btn.classList.add('save_btn');
            cancel_btn.classList.add('cancel_btn');
            toolbar.classList.add('toolbar');
            
            save_btn.textContent = 'Save';
            cancel_btn.textContent = 'Cancel';

            toolbar.appendChild(input);
            toolbar.appendChild(cancel_btn);
            toolbar.appendChild(save_btn);

            td.innerHTML = '';
            td.appendChild(toolbar);

            save_btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.finishEditing(td);
            });

            cancel_btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.cancelEditing(td);
            });

            input.addEventListener('keydown', (e) => {
                if (e.key == 'Enter') {
                    this.finishEditing(td);
                }
                else if (e.key == 'Escape') {
                    this.cancelEditing(td);
                }
            });
        }

        findEditing() {
            let table_body = this.table.childNodes[0];
            let rows = table_body.childNodes;

            for (let row=0; row<rows.length; row++) {
                let cells = rows[row].childNodes;
                for (let col=0; col<cells.length; col++) {
                    if (cells[col].classList.contains('editing')) {
                        return cells[col];
                    }
                }
            }
            return null;

        }

        sendData(td, new_value) {
            let row_id = td.getAttribute('data-id');
            let cell_name = td.getAttribute('data-key');
            let cell_type = td.getAttribute('data-type');

            let current_value = td.getAttribute('data-value');
            
            if (new_value == current_value) {
                return;
            }

            const token = "{{ csrf_token }}";
            $.ajax({
                headers: { "X-CSRFToken": token },
                url: `/api/update/${this.table_name}/${row_id}/${cell_name}/${cell_type}/${new_value}/`,
                type: 'POST',
                success: function(response) {
                    console.log(response);

                    // When the server does not respond with a valid response
                    // -> reset the cell to its previous value
                    if (response.hasOwnProperty('new_value')) {
                        td.setAttribute('data-value', response['new_value']);
                    } else {
                        td.innerHTML = td.getAttribute('data-value');
                    }
                }
            })
        }
    }

    user_btn.addEventListener('click', () => {
        console.log("Fetching 'Users' table ...");
    
        $.ajax({
            url: '/api/get-table/users/0/10',
            type: 'GET',
            success: function(response) {
                current_table = new Table('users', response['headers'], response['types'], response['data']);
            }
        })
    });

    transaction_type_btn.addEventListener('click', () => {
        console.log("Fetching 'Transaction Types' table ...");

        $.ajax({
            url: '/api/get-table/transaction_types/0/10',
            type: 'GET',
            success: function(response) {
                current_table = new Table('transaction_types', response['headers'], response['types'], response['data']);
            }
        })
    });


</script>

</html>